<?xml version="1.0" encoding="utf-8"?>

<Project DefaultTargets="Test" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildProjectDirectory)\..\Digillect.Build.Tools\build\Digillect.Build.Packaging.NuGet.props" />

  <PropertyGroup>
    <NuSpecFileName>Digillect.Build.Tools.nuspec</NuSpecFileName>
    <NuSpecFilePath>$(MSBuildProjectDirectory)\..\Digillect.Build.Tools\$(NuSpecFileName)</NuSpecFilePath>
    <OutputPath>$(MSBuildProjectDirectory)\..\..\target\tests\</OutputPath>
  </PropertyGroup>

  <ItemGroup>
    <_TestItem Include="$(OutputPath)_._" />
  </ItemGroup>

  <ItemGroup>
    <NuPkgBuild Include="@(_TestItem)" />
    <NuPkgBuild Include="@(_TestItem)">
      <FxTarget>net40</FxTarget>
    </NuPkgBuild>
    <NuPkgBuild Include="@(_TestItem)">
      <FxTarget>portable</FxTarget>
      <FxProfile>net45+netcore45</FxProfile>
    </NuPkgBuild>
    <NuPkgContent Include="@(_TestItem)" />
    <NuPkgContent Include="@(_TestItem)">
      <FxTarget>net40</FxTarget>
    </NuPkgContent>
    <NuPkgContent Include="@(_TestItem)">
      <FxTarget>portable</FxTarget>
      <FxProfile>net45+netcore45</FxProfile>
    </NuPkgContent>
    <NuPkgLib Include="@(_TestItem)" />
    <NuPkgLib Include="@(_TestItem)">
      <FxTarget>net40</FxTarget>
    </NuPkgLib>
    <NuPkgLib Include="@(_TestItem)">
      <FxTarget>portable</FxTarget>
      <FxProfile>net45+netcore45</FxProfile>
    </NuPkgLib>
    <NuPkgTools Include="@(_TestItem)" />
    <NuPkgTools Include="@(_TestItem)">
      <FxTarget>net40</FxTarget>
    </NuPkgTools>
    <NuPkgTools Include="@(_TestItem)">
      <FxTarget>portable</FxTarget>
      <FxProfile>net45+netcore45</FxProfile>
    </NuPkgTools>
  </ItemGroup>

  <Import Project="$(MSBuildProjectDirectory)\..\Digillect.Build.Tools\build\Digillect.Build.Packaging.NuGet.targets" />

  <!-- Setup -->
  <Target Name="BeforeTest">
    <Message Text="CoreTestDependsOn=$(CoreTestDependsOn)"/>
    <ItemGroup>
      <_Sut Remove="@(_Sut)" />

      <_Sut Include="$(NuSpecFilePath)">
        <DestinationRelativeDir />
      </_Sut>
      <_Sut Include="@(NuPkgBuild)" Condition="'%(NuPkgBuild.FxTarget)' == '' And '%(NuPkgBuild.FxProfile)' == ''" />
      <_Sut Include="@(NuPkgBuild)" Condition="'%(NuPkgBuild.FxTarget)' != '' And '%(NuPkgBuild.FxProfile)' == ''">
        <DestinationRelativeDir>build\%(NuPkgBuild.FxTarget)\</DestinationRelativeDir>
      </_Sut>
      <_Sut Include="@(NuPkgBuild)" Condition="'%(NuPkgBuild.FxTarget)' != '' And '%(NuPkgBuild.FxProfile)' != ''">
        <DestinationRelativeDir>build\%(NuPkgBuild.FxTarget)-%(NuPkgBuild.FxProfile)\</DestinationRelativeDir>
      </_Sut>
      <_Sut Include="@(NuPkgContent)" />
      <_Sut Include="@(NuPkgContent)" Condition="'%(NuPkgContent.FxTarget)' != '' And '%(NuPkgContent.FxProfile)' == ''">
        <DestinationRelativeDir>build\%(NuPkgContent.FxTarget)\</DestinationRelativeDir>
      </_Sut>
      <_Sut Include="@(NuPkgContent)" Condition="'%(NuPkgContent.FxTarget)' != '' And '%(NuPkgContent.FxProfile)' != ''">
        <DestinationRelativeDir>build\%(NuPkgContent.FxTarget)-%(NuPkgContent.FxProfile)\</DestinationRelativeDir>
      </_Sut>
      <_Sut Include="@(NuPkgLib)" />
      <_Sut Include="@(NuPkgLib)" Condition="'%(NuPkgLib.FxTarget)' != '' And '%(NuPkgLib.FxProfile)' == ''">
        <DestinationRelativeDir>build\%(NuPkgLib.FxTarget)\</DestinationRelativeDir>
      </_Sut>
      <_Sut Include="@(NuPkgLib)" Condition="'%(NuPkgLib.FxTarget)' != '' And '%(NuPkgLib.FxProfile)' != ''">
        <DestinationRelativeDir>build\%(NuPkgLib.FxTarget)-%(NuPkgLib.FxProfile)\</DestinationRelativeDir>
      </_Sut>
      <_Sut Include="@(NuPkgTools)" />
      <_Sut Include="@(NuPkgTools)" Condition="'%(NuPkgTools.FxTarget)' != '' And '%(NuPkgTools.FxProfile)' == ''">
        <DestinationRelativeDir>build\%(NuPkgTools.FxTarget)\</DestinationRelativeDir>
      </_Sut>
      <_Sut Include="@(NuPkgTools)" Condition="'%(NuPkgTools.FxTarget)' != '' And '%(NuPkgTools.FxProfile)' != ''">
        <DestinationRelativeDir>build\%(NuPkgTools.FxTarget)-%(NuPkgTools.FxProfile)\</DestinationRelativeDir>
      </_Sut>
    </ItemGroup>
  </Target>

  <!-- Exercise -->
  <PropertyGroup>
    <CoreTestDependsOn>
      CleanPackageDirectory;
      _Init;
      CopyPackageFilesToDestination
    </CoreTestDependsOn>
  </PropertyGroup>

  <!-- Verify -->
  <Target Name="AfterTest" Outputs="$(OutputPath)%(_Sut.DestinationRelativeDir)%(_Sut.RecursiveDir)%(_Sut.Filename)%(_Sut.Extension)">
    <Error Condition="!Exists('$(OutputPath)%(_Sut.DestinationRelativeDir)%(_Sut.RecursiveDir)%(_Sut.Filename)%(_Sut.Extension)')" Text="Missing %(_Sut.DestinationRelativeDir)%(_Sut.RecursiveDir)%(_Sut.Filename)%(_Sut.Extension)" />
  </Target>

  <Target Name="_Init">
    <MakeDir Directories="@(_TestItem->DirectoryName())" />
    <Touch Files="@(_TestItem)" AlwaysCreate="true" ForceTouch="true" />
  </Target>
</Project>
